# Epguides API - Cursor Rules

## ⚠️ CRITICAL: Always Use Virtual Environment
```bash
cd /Users/frecar/code/epguides-api && source venv/bin/activate && <command>
```

## Quick Reference
| Command | Purpose |
|---------|---------|
| `make test` | Run tests (100% coverage required) |
| `make fix` | Format (black) + lint (ruff) |
| `make up` | Start dev Docker (Redis + API with reload) |
| `make up-prod` | Start prod Docker (optimized uvicorn) |
| `make down` | Stop all Docker services |
| `make cache-clear` | Flush Redis cache |

## Testing
- **100% test coverage** enforced by pre-commit (blocks commit if < 100%)
- **Performance tests** in `test_performance.py`: < 50ms hard limit, < 20ms target
- Mock patterns:
  ```python
  @patch("app.core.cache.cache_get", return_value=None)  # Cache miss
  @patch("app.services.show_service.get_show")           # Service layer
  ```
- If code can't be tested, **remove it** - no `# pragma: no cover`

## Code Patterns

### Caching (app/core/cache.py)
```python
# Use the @cached decorator for Pydantic models
@cached("show:{show_id}", ttl=TTL_7_DAYS, model=ShowSchema, key_transform=normalize_show_id)
async def get_show(show_id: str) -> ShowSchema | None:
    ...

# TTL constants
TTL_7_DAYS   # Ongoing shows, episodes, seasons
TTL_30_DAYS  # Show list, indexes
TTL_1_YEAR   # Finished shows (won't change)
```

### Schemas
```python
# Always use factory function (handles defaults)
show = create_show_schema(epguides_key="test", title="Test")

# NOT direct instantiation (requires all fields)
show = ShowSchema(...)  # Don't do this
```

### Async Services
```python
# Parallel fetches for performance
results = await asyncio.gather(
    epguides.get_episodes_data(show_id),
    epguides.get_maze_id_for_show(show_id),
)
```

## Project Structure
```
app/
├── api/endpoints/     # REST routes (FastAPI routers)
│   ├── shows.py       # /shows/* endpoints
│   └── mcp.py         # /mcp endpoint (JSON-RPC wrapper)
├── core/
│   ├── cache.py       # Redis caching, @cached decorator
│   ├── config.py      # Settings from env vars
│   ├── constants.py   # TTLs, version, URLs
│   └── middleware.py  # Request logging
├── mcp/server.py      # MCP protocol implementation
├── models/
│   ├── schemas.py     # ShowSchema, EpisodeSchema, etc.
│   └── responses.py   # PaginatedResponse
├── services/
│   ├── show_service.py  # Business logic
│   ├── epguides.py      # External API calls
│   └── llm_service.py   # Natural language queries
└── tests/             # pytest suite (100% coverage)
docs/                  # ReadTheDocs (mkdocs)
```

## When Making Changes
1. Run `make fix` then `make test` before committing
2. Update docstrings if function behavior changes
3. Update `docs/*.md` if adding features/endpoints
4. Keep Swagger `summary` and `description` current
5. Version auto-increments via pre-commit hook
