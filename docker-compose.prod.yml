# =============================================================================
# Production Configuration
# Usage: make up-prod  (or: docker compose -f docker-compose.prod.yml up)
# =============================================================================
# Optimized for 16-core server with 5GB Redis cache

services:
  epguides-api:
    build:
      context: .
    # 12 workers = 16 cores - 4 (reserved for Redis + OS)
    # uvloop + httptools: ~2x faster than default asyncio
    command: >
      uvicorn app.main:app
      --host 0.0.0.0
      --port 3000
      --workers 12
      --loop uvloop
      --http httptools
      --timeout-keep-alive 30
      --limit-concurrency 1000
      --backlog 2048
      --log-level warning
    ports:
      - "3000:3000"
    env_file:
      - .env
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - PYTHONOPTIMIZE=2
    depends_on:
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "12"
          memory: 4G
        reservations:
          cpus: "4"
          memory: 1G
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:3000/health",
        ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  redis:
    image: redis:7
    command: >
      redis-server
      --maxmemory 5120mb
      --maxmemory-policy allkeys-lru
      --save ""
      --appendonly no
      --io-threads 8
      --io-threads-do-reads yes
      --tcp-backlog 65535
      --tcp-keepalive 300
      --timeout 0
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    sysctls:
      - net.core.somaxconn=65535
    deploy:
      resources:
        limits:
          cpus: "4"
          memory: 6G
        reservations:
          cpus: "2"
          memory: 5G
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

volumes:
  redis-data:
