# =============================================================================
# Production Configuration
# Usage: make up-prod  (or: docker compose -f docker-compose.prod.yml up)
# =============================================================================
# Optimized for 6-core / 5GB server
# Memory: API 1.5GB + Redis 3GB + OS ~500MB = 5GB

services:
  epguides-api:
    build:
      context: .
    # 5 workers = 6 cores - 1 (reserved for Redis + OS)
    # uvloop + httptools: ~2x faster than default asyncio
    command: >
      uvicorn app.main:app
      --host 0.0.0.0
      --port 3000
      --workers 5
      --loop uvloop
      --http httptools
      --timeout-keep-alive 30
      --limit-concurrency 500
      --backlog 1024
      --log-level warning
    ports:
      - "3000:3000"
    environment:
      PYTHONDONTWRITEBYTECODE: "1"
      PYTHONUNBUFFERED: "1"
      PYTHONOPTIMIZE: "2"
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      CACHE_TTL_SECONDS: ${CACHE_TTL_SECONDS:-3600}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      API_BASE_URL: ${API_BASE_URL:-https://epguides.frecar.no}
      LOG_REQUESTS: ${LOG_REQUESTS:-true}
      LLM_ENABLED: ${LLM_ENABLED:-true}
      LLM_API_URL: ${LLM_API_URL:-}
      LLM_API_KEY: ${LLM_API_KEY:-}
      SENTRY_DSN: ${SENTRY_DSN:-}
    depends_on:
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "5"
          memory: 1536M
        reservations:
          cpus: "2"
          memory: 512M
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:3000/health')",
        ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  redis:
    image: redis:7
    command: >
      redis-server
      --maxmemory 3gb
      --maxmemory-policy allkeys-lru
      --save ""
      --appendonly no
      --io-threads 2
      --io-threads-do-reads yes
      --tcp-backlog 511
      --tcp-keepalive 300
      --timeout 0
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    sysctls:
      - net.core.somaxconn=511
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 3G
        reservations:
          cpus: "0.5"
          memory: 1G
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

volumes:
  redis-data:
